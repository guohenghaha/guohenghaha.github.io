---
date: 2021-02-09
layout: post
title: 汇编学习笔记 
description: "重新温习下汇编"
categories: [计算机基础, 笔记]
---

最近准备写一篇「concurrent programming」的文章，准备材料的时候发现原子指令的实现需要总线锁和缓存锁，而自己对于计算机体系结构所知甚少所以这块很难理解，基本还给大学《微机原理》课程的老师了，所以开始研读《计算机组成与设计：硬件软件接口》，但是这本书要求基本的汇编语言经验，所以 download 了一本王爽老师的《汇编语言》开始学习。

本文用的 CPU 为 8086（16 位）CPU。

## 基础知识

CPU 组成：
- 寄存器
- 运算器，运算单元，比如加法器
- 控制器，各种控制电路
- 总线，连接这些器件

### 总线

地址总线，用于寻址。
数据总线，用于读写数据
控制总线，用于多种控制线的总称。

比如 8086 CPU：

![8086 CPU]("/images/8086.png")

因为是 16 位 CPU，所以寄存器大小是 16 位，对应的数据线也是 16 位（AD0-AD15）。

但是地址线位 20 位（AD0～AD19），原因是如果地址线位 16 位，那么限制了寻址范围位 2 ** 16 Byte = 64K，20 位的话寻址范围可以增大到 1M。

既然寄存器只能存储 16 位的数据，那么 20 位的数据地址如何存储呢？可以使用两个 16 位地址组成一个 20 位地址，地址 A * 16 + 地址 B。注意「* 16」的意思是往左移动 4 位，这样两个 16 位的地址组成了一个 20 位的地址。地址 A 为段地址，存储在段寄存器，地址 B 为偏移地址。

不只是内存，CPU 把其他外围组件，比如装有 BIOS 的 ROM，显存等等都统一为一个逻辑内存地址空间。

![逻辑内存]("/images/logic_memory.png")

### 寄存器

对汇编程序员来说，寄存器是最重要的。8086 有 16 个寄存器：

AX-DX 为通用寄存器，每个可以拆分为高位和低位，比如 16 位 的 AX 拆分为两个八位的 AH AL。

CS 为代码段寄存器，IP 为指令寄存器，CS * 16 + IP 组成了下一条指令的地址。（计算机启动的时候会初始化 CS IP，执行 ROM 中的第一条指令）

DS 为要访问的数据的段地址。

SS 存放栈顶段地址，SP 存放栈顶偏移地址，SS * 16 + SP 指向栈顶元素。

### 指令

mov 指令，在寄存器和内存，或者寄存器之前传送数据。这是最基础的指令，用于给寄存器赋值。

![mov]("/images/mov.png")

可以看出 CPU 不能直接往内存单元写数据，需要先写到寄存器。

jmp 指令，修改 CS 和 IP，改变下一条指令的地址。（mov 指令不能直接修改 CS 和 IP）

```
jmp 2AE3:3, 执行之后 CS = 2AE3H，IP = 0003H, 程序从 2AE33H 读取指令。
```

push pop 指令，TBD。。
